name: Terraform CI/CD

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Layers/EC2CleanUp/base/**'
      - 'Layers/EC2CleanUp/lambda/**'
      - 'environment/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
      - master
      - develop
      - dev
    paths:
      - 'Layers/EC2CleanUp/base/**'
      - 'Layers/EC2CleanUp/lambda/**'
      - 'environment/**'
      - '.github/workflows/terraform.yml'

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-west-2'

jobs:
  terraform-backend-bootstrap-dev:
    name: Bootstrap Backend (DEV)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/base
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init (Backend)
        run: terraform init

      - name: Terraform Plan (Backend DEV)
        run: |
          terraform plan -no-color \
            -var="environment=dev" \
            -var="bucket_name=ec2-snapshot-cleanup" \
            -var="dynamodb_table_name=terraform-state-lock" \
            -var="aws_region=${{ env.AWS_REGION }}"

      - name: Terraform Apply (Backend DEV)
        run: |
          terraform apply -auto-approve \
            -var="environment=dev" \
            -var="bucket_name=ec2-snapshot-cleanup" \
            -var="dynamodb_table_name=terraform-state-lock" \
            -var="aws_region=${{ env.AWS_REGION }}"
        continue-on-error: true  # Allow failure if backend already exists

      - name: Get Backend Output
        id: backend-output
        run: |
          BUCKET_NAME=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
          if [ -n "$BUCKET_NAME" ]; then
            echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
            echo "âœ… Backend bucket created: $BUCKET_NAME"
          else
            echo "âš ï¸  Could not retrieve bucket name"
          fi

  terraform-backend-bootstrap-prod:
    name: Bootstrap Backend (PROD)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/base
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init (Backend)
        run: terraform init

      - name: Terraform Plan (Backend PROD)
        run: |
          terraform plan -no-color \
            -var="environment=prod" \
            -var="bucket_name=ec2-snapshot-cleanup" \
            -var="dynamodb_table_name=terraform-state-lock" \
            -var="aws_region=${{ env.AWS_REGION }}"

      - name: Terraform Apply (Backend PROD)
        run: |
          terraform apply -auto-approve \
            -var="environment=prod" \
            -var="bucket_name=ec2-snapshot-cleanup" \
            -var="dynamodb_table_name=terraform-state-lock" \
            -var="aws_region=${{ env.AWS_REGION }}"
        continue-on-error: true  # Allow failure if backend already exists

  lambda-lint-test:
    name: Lambda Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda/code

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8 pylint boto3-stubs[essential]

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Lint with pylint
        run: |
          pylint lambda_function.py --disable=C0103,C0111 || true

      - name: Python Syntax Check
        run: python -m py_compile lambda_function.py

  terraform-fmt-validate:
    name: Terraform Format & Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Security Scan
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: Layers/EC2CleanUp/lambda
        continue-on-error: true

  terraform-plan-dev:
    name: Terraform Plan (DEV)
    runs-on: ubuntu-latest
    needs: [lambda-lint-test, terraform-fmt-validate, terraform-backend-bootstrap-dev]
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify environment files exist (DEV)
        run: |
          echo "Workspace: ${{ github.workspace }}"
          echo "Working directory: $(pwd)"
          echo "Checking for backend.hcl..."
          ls -la ${{ github.workspace }}/environment/dev/backend.hcl || echo "âŒ backend.hcl not found"
          echo "Checking for terraform.tfvars..."
          ls -la ${{ github.workspace }}/environment/dev/terraform.tfvars || echo "âŒ terraform.tfvars not found"
          echo "Listing environment/dev directory:"
          ls -la ${{ github.workspace }}/environment/dev/ || echo "âŒ environment/dev directory not found"

      - name: Terraform Init (DEV)
        run: terraform init -backend-config=${{ github.workspace }}/environment/dev/backend.hcl

      - name: Terraform Plan (DEV)
        id: plan-dev
        run: |
          terraform plan -no-color -out=tfplan-dev -var-file=${{ github.workspace }}/environment/dev/terraform.tfvars > plan_output_dev.txt 2>&1
        continue-on-error: true

      - name: Show Plan Output (DEV)
        if: steps.plan-dev.outcome == 'failure'
        run: |
          echo "âŒ Terraform Plan failed. Output:"
          echo "=================================="
          cat plan_output_dev.txt
          echo "=================================="

      - name: Terraform Plan Status (DEV)
        if: steps.plan-dev.outcome == 'failure'
        run: exit 1

      - name: Comment PR with Plan (DEV)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let planOutput = '';
            try {
              planOutput = fs.readFileSync('plan_output_dev.txt', 'utf8');
            } catch (error) {
              planOutput = 'Plan output could not be captured. Check workflow logs for details.';
            }
            
            const output = `#### Terraform Plan (DEV) ðŸ“–
            \`\`\`
            ${planOutput.substring(0, 60000)}
            \`\`\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Environment: \`dev\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-apply-dev:
    name: Terraform Apply (DEV)
    runs-on: ubuntu-latest
    needs: terraform-plan-dev
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init (DEV)
        run: terraform init -backend-config=${{ github.workspace }}/environment/dev/backend.hcl

      - name: Terraform Apply (DEV)
        run: terraform apply -auto-approve -var-file=${{ github.workspace }}/environment/dev/terraform.tfvars

      - name: Terraform Output (DEV)
        id: output-dev
        run: terraform output -json > ${{ github.workspace }}/environment/dev/output.json
        continue-on-error: true

      - name: Upload Terraform Output (DEV)
        uses: actions/upload-artifact@v4
        if: steps.output-dev.outcome == 'success'
        with:
          name: terraform-output-dev
          path: environment/dev/output.json
          retention-days: 7

  terraform-plan-prod:
    name: Terraform Plan (PROD)
    runs-on: ubuntu-latest
    needs: [terraform-apply-dev, terraform-backend-bootstrap-prod]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify environment files exist (PROD)
        run: |
          echo "Workspace: ${{ github.workspace }}"
          echo "Working directory: $(pwd)"
          echo "Checking for backend.hcl..."
          ls -la ${{ github.workspace }}/environment/prod/backend.hcl || echo "âŒ backend.hcl not found"
          echo "Checking for terraform.tfvars..."
          ls -la ${{ github.workspace }}/environment/prod/terraform.tfvars || echo "âŒ terraform.tfvars not found"
          echo "Listing environment/prod directory:"
          ls -la ${{ github.workspace }}/environment/prod/ || echo "âŒ environment/prod directory not found"

      - name: Terraform Init (PROD)
        run: terraform init -backend-config=${{ github.workspace }}/environment/prod/backend.hcl

      - name: Terraform Plan (PROD)
        id: plan-prod
        run: |
          terraform plan -no-color -out=tfplan-prod -var-file=${{ github.workspace }}/environment/prod/terraform.tfvars > plan_output_prod.txt 2>&1
        continue-on-error: true

      - name: Show Plan Output (PROD)
        if: steps.plan-prod.outcome == 'failure'
        run: |
          echo "âŒ Terraform Plan failed. Output:"
          echo "=================================="
          cat plan_output_prod.txt
          echo "=================================="

      - name: Terraform Plan Status (PROD)
        if: steps.plan-prod.outcome == 'failure'
        run: exit 1

      - name: Comment PR with Plan (PROD)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let planOutput = '';
            try {
              planOutput = fs.readFileSync('plan_output_prod.txt', 'utf8');
            } catch (error) {
              planOutput = 'Plan output could not be captured. Check workflow logs for details.';
            }
            
            const output = `#### Terraform Plan (PROD) ðŸ“–
            \`\`\`
            ${planOutput.substring(0, 60000)}
            \`\`\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Environment: \`prod\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-apply-prod:
    name: Terraform Apply (PROD)
    runs-on: ubuntu-latest
    needs: terraform-plan-prod
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    defaults:
      run:
        working-directory: ./Layers/EC2CleanUp/lambda

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init (PROD)
        run: terraform init -backend-config=${{ github.workspace }}/environment/prod/backend.hcl

      - name: Terraform Apply (PROD)
        run: terraform apply -auto-approve -var-file=${{ github.workspace }}/environment/prod/terraform.tfvars

      - name: Terraform Output (PROD)
        id: output-prod
        run: terraform output -json > ${{ github.workspace }}/environment/prod/output.json
        continue-on-error: true

      - name: Upload Terraform Output (PROD)
        uses: actions/upload-artifact@v4
        if: steps.output-prod.outcome == 'success'
        with:
          name: terraform-output-prod
          path: environment/prod/output.json
          retention-days: 7
